<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Learning Player</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM (Usando CDNJS para mayor estabilidad) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. Lucide Icons (Versión 0.263.1 probada para UMD) -->
    <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #18181b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }
        
        /* Asegura que el input de rango esté por encima visualmente para poder hacer clic */
        input[type=range] {
            z-index: 20;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-black text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // ACCESO SEGURO A ICONOS
        // Si window.lucideReact no existe, usamos un objeto vacío para evitar crash
        const L = window.lucideReact || {};

        // Componente Icono Seguro: Si el icono falla, no rompe la app
        const Icon = ({ name, size = 24, className, fill }) => {
            const IconComp = L[name];
            if (!IconComp) {
                // Fallback visual si no carga el icono
                if (name === 'Play') return <span className="text-xs font-bold text-black">▶</span>;
                if (name === 'Pause') return <span className="text-xs font-bold text-black">||</span>;
                return null; 
            }
            return <IconComp size={size} className={className} fill={fill} />;
        };

        // URL DE BASE DE DATOS
        const API_URL = "./database.json";

        function App() {
            // --- ESTADOS ---
            const [db, setDb] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [view, setView] = useState('home'); 
            const [activeTopic, setActiveTopic] = useState(null);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

            // --- PLAYER STATES ---
            const [currentTrack, setCurrentTrack] = useState(null);
            const [isPlaying, setIsPlaying] = useState(false);
            const [isBuffering, setIsBuffering] = useState(false);
            const [progress, setProgress] = useState(0);
            const [duration, setDuration] = useState(0);
            const [playbackError, setPlaybackError] = useState(null);
            
            const audioRef = useRef(null);

            // --- CARGAR DATOS ---
            useEffect(() => {
                fetch(API_URL)
                    .then(res => {
                        if (!res.ok) throw new Error("Error cargando database.json");
                        return res.json();
                    })
                    .then(data => {
                        setDb(data);
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error(err);
                        setError("No se pudo cargar el contenido.");
                        setLoading(false);
                    });
            }, []);

            // --- CONTROL REPRODUCCIÓN ---
            useEffect(() => {
                if (!audioRef.current || !currentTrack) return;

                if (isPlaying) {
                    const playPromise = audioRef.current.play();
                    if (playPromise !== undefined) {
                        playPromise
                            .then(() => {
                                setIsBuffering(false);
                                setPlaybackError(null);
                            })
                            .catch(e => {
                                if (e.name !== 'AbortError') console.error("Error play:", e);
                            });
                    }
                } else {
                    audioRef.current.pause();
                }
            }, [isPlaying, currentTrack]);

            // --- HANDLERS ---
            const handleTimeUpdate = () => {
                if (audioRef.current) {
                    const curr = audioRef.current.currentTime;
                    const dur = audioRef.current.duration;
                    if (dur > 0) {
                        setProgress((curr / dur) * 100);
                        setDuration(dur);
                    }
                }
            };

            const formatTime = (seconds) => {
                if (!seconds || isNaN(seconds)) return "0:00";
                const m = Math.floor(seconds / 60);
                const s = Math.floor(seconds % 60);
                return `${m}:${s < 10 ? '0' : ''}${s}`;
            };

            const playTrack = (track, topic) => {
                if (currentTrack?.id === track.id) {
                    setIsPlaying(!isPlaying);
                } else {
                    setCurrentTrack(track);
                    setActiveTopic(topic);
                    setIsPlaying(true);
                    setIsBuffering(true);
                    setProgress(0);
                }
            };

            const playNextOrPrev = (dir) => {
                if (!activeTopic) return;
                const idx = activeTopic.chapters.findIndex(c => c.id === currentTrack?.id);
                if (idx === -1) return;
                
                let nextIdx = dir === 'next' ? idx + 1 : idx - 1;
                if (nextIdx >= activeTopic.chapters.length) nextIdx = 0;
                if (nextIdx < 0) nextIndex = activeTopic.chapters.length - 1; // Corrección typo anterior
                
                playTrack(activeTopic.chapters[nextIdx], activeTopic);
            };

            // --- HELPERS UI ---
            const CoverArt = ({ topic, className, size=24 }) => {
                if (topic.coverImage) {
                    return <img src={topic.coverImage} className={`object-cover bg-zinc-800 ${className}`} />;
                }
                return (
                    <div className={`bg-gradient-to-br ${topic.coverColor || 'from-gray-700 to-gray-900'} flex items-center justify-center ${className}`}>
                        <Icon name="ListMusic" size={size} className="text-white/50" />
                    </div>
                );
            };

            // --- RENDER ---
            if (loading) return <div className="h-screen bg-black flex items-center justify-center text-green-500">Cargando...</div>;
            if (error) return <div className="h-screen bg-black flex items-center justify-center text-red-500">{error}</div>;

            const allTopics = db.flatMap(cat => cat.topics || []);

            return (
                <div className="flex flex-col h-screen bg-black text-white font-sans overflow-hidden">
                    
                    {/* AREA PRINCIPAL */}
                    <div className="flex flex-1 overflow-hidden">
                        {/* SIDEBAR */}
                        <aside className="w-64 bg-black border-r border-zinc-800 hidden md:flex flex-col p-2 gap-2">
                            <div className="bg-zinc-900 rounded-lg p-4 space-y-4">
                                <div onClick={() => {setView('home'); setMobileMenuOpen(false);}} className="flex items-center gap-4 cursor-pointer hover:text-white text-zinc-400 font-bold transition">
                                    <Icon name="Home"/> Inicio
                                </div>
                                <div className="flex items-center gap-4 cursor-pointer hover:text-white text-zinc-400 font-bold transition">
                                    <Icon name="Search"/> Buscar
                                </div>
                            </div>
                            <div className="bg-zinc-900 rounded-lg flex-1 p-4 overflow-y-auto">
                                <div className="flex items-center gap-2 mb-4 text-zinc-400 font-bold">
                                    <Icon name="Library"/> Biblioteca
                                </div>
                                {db.map(cat => (
                                    <div key={cat.id} className="mb-6">
                                        <h3 className="text-xs font-bold text-zinc-500 uppercase mb-2">{cat.name}</h3>
                                        {cat.topics?.map(topic => (
                                            <div key={topic.id} onClick={() => { setActiveTopic(topic); setView('topic'); }} className="flex items-center gap-3 p-2 hover:bg-zinc-800 rounded cursor-pointer">
                                                <div className="w-10 h-10 rounded overflow-hidden flex-shrink-0">
                                                    <CoverArt topic={topic} className="w-full h-full" size={16} />
                                                </div>
                                                <p className="text-sm font-medium truncate">{topic.title}</p>
                                            </div>
                                        ))}
                                    </div>
                                ))}
                            </div>
                        </aside>

                        {/* MAIN CONTENT */}
                        <main className="flex-1 bg-black overflow-y-auto relative">
                            {/* Mobile Header */}
                            <div className="md:hidden sticky top-0 z-20 bg-black/90 backdrop-blur p-4 flex justify-between items-center border-b border-zinc-800">
                                <div onClick={() => setView('home')} className="font-bold flex items-center gap-2">
                                    {view === 'topic' && <Icon name="ChevronLeft"/>} E-Learning
                                </div>
                                <div onClick={() => setMobileMenuOpen(!mobileMenuOpen)}><Icon name="Menu"/></div>
                            </div>

                            {/* Mobile Menu */}
                            {mobileMenuOpen && (
                                <div className="absolute inset-0 z-30 bg-black p-6 flex flex-col gap-4">
                                    <button onClick={() => {setView('home'); setMobileMenuOpen(false);}} className="text-xl font-bold flex gap-2"><Icon name="Home"/> Inicio</button>
                                    <div className="h-px bg-zinc-800 w-full"></div>
                                    <div className="overflow-y-auto flex-1">
                                        {allTopics.map(topic => (
                                            <div key={topic.id} onClick={() => { setActiveTopic(topic); setView('topic'); setMobileMenuOpen(false); }} className="py-3 text-lg border-b border-zinc-900 text-zinc-300">
                                                {topic.title}
                                            </div>
                                        ))}
                                    </div>
                                    <button onClick={() => setMobileMenuOpen(false)} className="py-4 text-center text-zinc-500">Cerrar</button>
                                </div>
                            )}

                            <div className="p-4 md:p-8 pb-32">
                                {view === 'home' && (
                                    <>
                                        <h1 className="text-2xl font-bold mb-6">Buenas tardes</h1>
                                        {allTopics.length === 0 ? (
                                            <div className="text-zinc-500">No hay contenido.</div>
                                        ) : (
                                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                                                {allTopics.map(topic => (
                                                    <div key={topic.id} onClick={() => { setActiveTopic(topic); setView('topic'); }} className="bg-zinc-900 p-4 rounded-md hover:bg-zinc-800 transition cursor-pointer group">
                                                        <div className="aspect-square w-full mb-4 shadow-lg relative">
                                                            <CoverArt topic={topic} className="w-full h-full rounded-md" size={48} />
                                                            <div className="absolute bottom-2 right-2 bg-green-500 rounded-full p-3 shadow-xl opacity-0 translate-y-2 group-hover:opacity-100 group-hover:translate-y-0 transition-all">
                                                                <Icon name="Play" fill="black" className="text-black ml-1"/>
                                                            </div>
                                                        </div>
                                                        <h3 className="font-bold truncate">{topic.title}</h3>
                                                        <p className="text-sm text-zinc-400 line-clamp-2">{topic.description}</p>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </>
                                )}

                                {view === 'topic' && activeTopic && (
                                    <>
                                        <div className="flex flex-col md:flex-row items-end gap-6 p-6 bg-gradient-to-b from-zinc-800 to-black rounded-t-xl">
                                            <div className="w-48 h-48 shadow-2xl flex-shrink-0 mx-auto md:mx-0 rounded overflow-hidden">
                                                <CoverArt topic={activeTopic} className="w-full h-full" size={64} />
                                            </div>
                                            <div className="flex flex-col gap-2 w-full text-center md:text-left">
                                                <span className="uppercase text-xs font-bold tracking-wider">Lección</span>
                                                <h1 className="text-3xl md:text-5xl font-black">{activeTopic.title}</h1>
                                                <p className="text-white/80">{activeTopic.description}</p>
                                                <p className="text-sm font-bold mt-2">{activeTopic.chapters.length} capítulos</p>
                                            </div>
                                        </div>

                                        <div className="py-6">
                                            <button 
                                                onClick={() => activeTopic.chapters.length > 0 && playTrack(activeTopic.chapters[0], activeTopic)} 
                                                className="w-14 h-14 bg-green-500 rounded-full flex items-center justify-center hover:scale-105 transition shadow-lg"
                                            >
                                                <Icon name={isPlaying && activeTopic.chapters.some(c => c.id === currentTrack?.id) ? "Pause" : "Play"} fill="black" className="text-black ml-1" />
                                            </button>
                                        </div>

                                        <div className="flex flex-col">
                                            <div className="grid grid-cols-[16px_1fr_auto] gap-4 px-4 py-2 border-b border-zinc-800 text-zinc-400 text-sm">
                                                <span>#</span><span>Título</span><Icon name="Clock" size={16}/>
                                            </div>
                                            {activeTopic.chapters.map((chapter, index) => {
                                                const isCurrent = currentTrack?.id === chapter.id;
                                                return (
                                                    <div key={chapter.id} onClick={() => playTrack(chapter, activeTopic)} className={`grid grid-cols-[16px_1fr_auto] gap-4 px-4 py-3 rounded-md hover:bg-white/10 cursor-pointer group items-center text-sm ${isCurrent ? 'text-green-500' : 'text-zinc-400'}`}>
                                                        <span className="flex justify-center w-4">
                                                            {isCurrent && isPlaying ? 
                                                                <div className="w-3 h-3 bg-green-500 rounded-full animate-pulse"/> : 
                                                                <span className="group-hover:hidden">{index + 1}</span>
                                                            }
                                                            <Icon name="Play" size={12} className={`hidden ${!isCurrent || !isPlaying ? 'group-hover:block' : ''} text-white`}/>
                                                        </span>
                                                        <div className="flex flex-col min-w-0">
                                                            <span className={`text-base font-medium truncate ${isCurrent ? 'text-green-500' : 'text-white'}`}>{chapter.title}</span>
                                                        </div>
                                                        <span>{chapter.duration || "--:--"}</span>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    </>
                                )}
                                <div className="h-24"></div>
                            </div>
                        </main>
                    </div>

                    {/* REPRODUCTOR (FOOTER) */}
                    <footer className="h-24 bg-zinc-900 border-t border-zinc-800 px-4 flex items-center justify-between z-50 fixed bottom-0 w-full">
                        <div className="w-1/3 flex items-center gap-4">
                            {currentTrack && (
                                <>
                                    <div className="hidden md:block w-14 h-14 rounded overflow-hidden">
                                        <CoverArt topic={activeTopic} className="w-full h-full" size={24} />
                                    </div>
                                    <div className="flex flex-col overflow-hidden">
                                        <span className="text-sm font-medium text-white truncate">{currentTrack.title}</span>
                                        <span className="text-xs text-zinc-400 truncate">{activeTopic?.title}</span>
                                    </div>
                                </>
                            )}
                        </div>

                        <div className="w-1/3 flex flex-col items-center gap-2">
                            <div className="flex items-center gap-6">
                                <button onClick={() => playNextOrPrev('prev')} className="text-zinc-400 hover:text-white"><Icon name="SkipBack" size={24}/></button>
                                <button 
                                    onClick={() => setIsPlaying(!isPlaying)} 
                                    disabled={!currentTrack}
                                    className="w-10 h-10 bg-white rounded-full flex items-center justify-center hover:scale-105 transition disabled:opacity-50"
                                >
                                    {isBuffering ? <Icon name="Loader2" size={20} className="text-black animate-spin"/> : 
                                     (isPlaying ? <Icon name="Pause" size={20} fill="black" className="text-black"/> : <Icon name="Play" size={20} fill="black" className="text-black ml-1"/>)}
                                </button>
                                <button onClick={() => playNextOrPrev('next')} className="text-zinc-400 hover:text-white"><Icon name="SkipForward" size={24}/></button>
                            </div>
                            
                            {/* BARRA DE PROGRESO */}
                            <div className="w-full flex items-center gap-2 text-xs text-zinc-400 select-none">
                                <span>{formatTime(audioRef.current?.currentTime || 0)}</span>
                                <div className="h-1 flex-1 bg-zinc-600 rounded-full relative group">
                                    <div className="h-full bg-white group-hover:bg-green-500 absolute top-0 left-0 rounded-full pointer-events-none" style={{ width: `${progress}%` }}></div>
                                    <input 
                                        type="range" 
                                        min="0" 
                                        max="100" 
                                        value={progress} 
                                        onChange={(e) => {
                                            const newTime = (e.target.value / 100) * duration;
                                            if(audioRef.current) {
                                                audioRef.current.currentTime = newTime;
                                                setProgress(e.target.value);
                                            }
                                        }} 
                                        className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                        disabled={!currentTrack}
                                    />
                                </div>
                                <span>{formatTime(duration)}</span>
                            </div>
                        </div>

                        <div className="w-1/3 flex justify-end items-center gap-2">
                            <Icon name="Volume2" size={20} className="text-zinc-400"/>
                            <div className="w-20 h-1 bg-zinc-600 rounded-full hidden md:block relative">
                                <div className="w-2/3 h-full bg-zinc-400 rounded-full absolute top-0"></div>
                            </div>
                        </div>
                    </footer>

                    {/* ELEMENTO DE AUDIO */}
                    <audio 
                        ref={audioRef} 
                        src={currentTrack?.url}
                        onTimeUpdate={handleTimeUpdate} 
                        onEnded={() => playNextOrPrev('next')} 
                        onLoadedData={() => setIsBuffering(false)}
                        onWaiting={() => setIsBuffering(true)}
                        onError={(e) => console.error("Error audio:", e)}
                    />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
