<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Learning Player</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM (Versiones específicas para estabilidad) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel (para entender JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. Lucide Icons (Versión Actualizada y Compatible) -->
    <!-- Se actualizó a la versión 0.469.0 para corregir el error de 'forwardRef' -->
    <script src="https://unpkg.com/lucide-react@0.469.0/dist/umd/lucide-react.min.js"></script>

    <style>
        /* Personalización de scrollbar para un look más "app" */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #18181b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #3f3f46; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #52525b; 
        }
    </style>
</head>
<body class="bg-black text-white">
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURACIÓN E IMPORTACIONES ---
        const { useState, useRef, useEffect } = React;
        
        // Verificación de seguridad para Lucide
        if (typeof lucideReact === 'undefined') {
            console.error("La librería de iconos Lucide no se cargó correctamente.");
        }

        const { 
            Play, Pause, SkipBack, SkipForward, Home, Search, Library, 
            ChevronLeft, Menu, Volume2, ListMusic, Clock, Loader2, 
            AlertCircle, FolderTree, Image: ImageIcon, ExternalLink 
        } = window.lucideReact || {}; // Fallback para evitar crash total si falla la carga

        // APUNTAMOS AL ARCHIVO LOCAL EN GITHUB PAGES
        const API_URL = "./database.json";

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            // --- ESTADOS DE DATOS ---
            const [db, setDb] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            // --- ESTADOS DE NAVEGACIÓN ---
            const [view, setView] = useState('home'); 
            const [activeTopic, setActiveTopic] = useState(null);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

            // --- ESTADOS DEL REPRODUCTOR ---
            const [currentTrack, setCurrentTrack] = useState(null);
            const [isPlaying, setIsPlaying] = useState(false);
            const [isBuffering, setIsBuffering] = useState(false);
            const [progress, setProgress] = useState(0);
            const [duration, setDuration] = useState(0);
            const [playbackError, setPlaybackError] = useState(null);
            
            const audioRef = useRef(null);

            // --- CARGAR DATOS ---
            useEffect(() => {
                const fetchData = async () => {
                    try {
                        setLoading(true);
                        // Fetch simple al archivo JSON local
                        const response = await fetch(API_URL);
                        
                        if (!response.ok) {
                            throw new Error(`No se encontró el archivo database.json (${response.status})`);
                        }
                        
                        const data = await response.json();
                        setDb(data);
                    } catch (err) {
                        console.error("Error cargando base de datos:", err);
                        setError("No se pudo cargar el catálogo. Verifica que 'database.json' esté subido.");
                    } finally {
                        setLoading(false);
                    }
                };
                fetchData();
            }, []);

            // --- CONTROL DE REPRODUCCIÓN ---
            useEffect(() => {
                if (!audioRef.current || !currentTrack) return;

                const playAudio = async () => {
                    try {
                        if (isPlaying) {
                            const playPromise = audioRef.current.play();
                            if (playPromise !== undefined) {
                                playPromise
                                    .then(() => {
                                        setPlaybackError(null);
                                        setIsBuffering(false);
                                    })
                                    .catch(err => {
                                        if (err.name !== 'AbortError') {
                                            console.error("Error reproducción:", err);
                                            setIsPlaying(false);
                                        }
                                    });
                            }
                        } else {
                            audioRef.current.pause();
                        }
                    } catch (err) {
                        console.error("Excepción audio:", err);
                        setIsPlaying(false);
                    }
                };

                playAudio();
            }, [isPlaying, currentTrack]); 

            // --- EVENTOS DE AUDIO ---
            const handleTimeUpdate = () => {
                if (audioRef.current) {
                    const current = audioRef.current.currentTime;
                    const total = audioRef.current.duration;
                    if (total > 0 && !isNaN(total)) {
                        setProgress((current / total) * 100);
                        setDuration(total);
                    }
                }
            };

            const handleAudioError = (e) => {
                const errorObj = e.currentTarget.error;
                const errorCode = errorObj?.code;
                const errorMessage = errorObj?.message;
                
                console.error(`ERROR NATIVO (Code ${errorCode}): ${errorMessage}`);
                
                setIsBuffering(false);
                setIsPlaying(false);
                
                let userMsg = "Error al cargar audio.";
                if (errorCode === 4) userMsg = "Archivo no encontrado (404). Revisa rutas en database.json.";
                
                setPlaybackError(userMsg);
            };

            const handleLoadedData = () => {
                setIsBuffering(false);
                setPlaybackError(null);
            };

            const handleWaiting = () => {
                setIsBuffering(true);
            };

            // --- HELPERS DE NAVEGACIÓN ---
            const playTrack = (track, topic) => {
                setPlaybackError(null);
                if (currentTrack?.id === track.id) {
                    setIsPlaying(!isPlaying);
                    return;
                }
                
                setIsBuffering(true);
                setProgress(0);
                setDuration(0);
                
                setActiveTopic(topic); 
                setCurrentTrack(track);
                setIsPlaying(true);
            };

            const playNextOrPrev = (direction) => {
                if (!activeTopic || !currentTrack) return;
                const currentIndex = activeTopic.chapters.findIndex(c => c.id === currentTrack.id);
                if (currentIndex === -1) return;

                let nextIndex = direction === 'next' ? currentIndex + 1 : currentIndex - 1;
                
                if (nextIndex >= activeTopic.chapters.length) nextIndex = 0;
                if (nextIndex < 0) nextIndex = activeTopic.chapters.length - 1;

                playTrack(activeTopic.chapters[nextIndex], activeTopic);
            };

            const formatTime = (seconds) => {
                if (!seconds || isNaN(seconds)) return "0:00";
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            };

            // --- COMPONENTES UI ---
            const CoverArt = ({ topic, className, iconSize = 24 }) => {
                if (topic.coverImage) {
                    return <img src={topic.coverImage} alt={topic.title} className={`object-cover bg-zinc-800 ${className}`} onError={(e) => e.target.style.display = 'none'} />;
                }
                return (
                    <div className={`bg-gradient-to-br ${topic.coverColor || 'from-gray-700 to-gray-900'} flex items-center justify-center ${className}`}>
                        {ListMusic && <ListMusic size={iconSize} className="text-white/50" />}
                    </div>
                );
            };

            const openTopic = (topic) => { setActiveTopic(topic); setView('topic'); setMobileMenuOpen(false); };
            const goHome = () => { setView('home'); setMobileMenuOpen(false); };
            const allTopics = db.flatMap(cat => cat.topics ? cat.topics.map(t => ({...t, categoryName: cat.name})) : []);

            if (loading) return <div className="h-screen bg-black flex items-center justify-center">{Loader2 ? <Loader2 className="animate-spin text-green-500" size={48} /> : "Cargando..."}</div>;
            if (error) return (
                <div className="h-screen bg-black text-white flex flex-col items-center justify-center gap-4 p-8 text-center">
                    {AlertCircle && <AlertCircle className="text-red-500" size={48} />}
                    <h2 className="text-xl font-bold">Configuración Necesaria</h2>
                    <p className="text-zinc-400">{error}</p>
                    <div className="bg-zinc-900 p-4 rounded text-left text-sm font-mono text-green-400 mt-4 max-w-lg overflow-auto">
                        1. Sube un archivo llamado <strong>database.json</strong> a tu GitHub.<br/>
                        2. Crea una carpeta <strong>audios</strong> y sube tus mp3 ahí.<br/>
                        3. Asegúrate que las rutas en el JSON coincidan (ej: audios/tema1/archivo.mp3).
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col h-screen bg-black text-white overflow-hidden font-sans">
                    
                    {/* PRINCIPAL */}
                    <div className="flex flex-1 overflow-hidden">
                        {/* SIDEBAR */}
                        <aside className="w-64 bg-black flex-col gap-2 p-2 hidden md:flex border-r border-zinc-800">
                            <div className="bg-zinc-900 rounded-lg p-4 space-y-4">
                                <div onClick={goHome} className="flex items-center gap-4 cursor-pointer hover:text-white text-zinc-400 font-bold transition">
                                    {Home && <Home size={24}/>} Inicio
                                </div>
                                <div className="flex items-center gap-4 cursor-pointer hover:text-white text-zinc-400 font-bold transition">
                                    {Search && <Search size={24}/>} Buscar
                                </div>
                            </div>
                            <div className="bg-zinc-900 rounded-lg flex-1 p-4 flex flex-col overflow-hidden">
                                <div className="flex items-center gap-2 mb-4 text-zinc-400 font-bold">
                                    {Library && <Library size={24}/>} Biblioteca
                                </div>
                                <div className="overflow-y-auto flex-1 space-y-1 pr-2 scrollbar-thin">
                                    {db.map(cat => (
                                        <div key={cat.id} className="mb-4">
                                            <h3 className="text-xs font-bold text-zinc-500 uppercase mb-2">{cat.name}</h3>
                                            {cat.topics?.map(topic => (
                                                <div key={topic.id} onClick={() => openTopic(topic)} className="flex items-center gap-3 p-2 hover:bg-zinc-800 rounded cursor-pointer group">
                                                    <div className="w-8 h-8 rounded overflow-hidden flex-shrink-0">
                                                        <CoverArt topic={topic} className="w-full h-full" iconSize={14} />
                                                    </div>
                                                    <p className={`text-sm font-medium truncate ${activeTopic?.id === topic.id ? 'text-green-500' : ''}`}>{topic.title}</p>
                                                </div>
                                            ))}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </aside>

                        {/* CONTENIDO */}
                        <main className="flex-1 bg-black/95 rounded-lg md:m-2 md:ml-0 overflow-y-auto relative scrollbar-thin">
                            <div className="md:hidden sticky top-0 z-20 bg-black/90 backdrop-blur-md p-4 flex justify-between items-center">
                                <div onClick={goHome} className="font-bold flex items-center gap-2 cursor-pointer">
                                    {view === 'topic' && ChevronLeft && <ChevronLeft/>} E-Learning
                                </div>
                                {Menu && <Menu onClick={() => setMobileMenuOpen(!mobileMenuOpen)} />}
                            </div>

                            {/* CONTENIDO REAL */}
                            <div className="p-4 md:p-8 pb-32">
                                {view === 'home' && (
                                    <>
                                        <h1 className="text-2xl md:text-3xl font-bold mb-6">Buenas tardes</h1>
                                        {allTopics.length === 0 ? (
                                            <div className="text-center p-8 border border-zinc-700 rounded-lg bg-zinc-800/50">
                                                {FolderTree && <FolderTree size={48} className="mx-auto text-zinc-500 mb-4"/>}
                                                <h3 className="text-xl font-bold">Biblioteca Vacía</h3>
                                                <p className="text-zinc-400 mt-2">Revisa tu archivo database.json</p>
                                            </div>
                                        ) : (
                                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                                                {allTopics.map(topic => (
                                                    <div key={topic.id} onClick={() => openTopic(topic)} className="bg-zinc-900 p-4 rounded-md hover:bg-zinc-800 transition cursor-pointer group">
                                                        <div className="aspect-square w-full mb-4 shadow-lg relative group-hover:scale-105 transition-transform duration-300">
                                                            <CoverArt topic={topic} className="w-full h-full rounded-md shadow-lg" iconSize={48} />
                                                            <div className="absolute bottom-2 right-2 bg-green-500 rounded-full p-3 shadow-xl opacity-0 translate-y-2 group-hover:opacity-100 group-hover:translate-y-0 transition-all duration-300 z-10">
                                                                {Play && <Play fill="black" size={20} className="text-black ml-1"/>}
                                                            </div>
                                                        </div>
                                                        <h3 className="font-bold truncate">{topic.title}</h3>
                                                        <p className="text-sm text-zinc-400 line-clamp-2">{topic.description}</p>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </>
                                )}

                                {view === 'topic' && activeTopic && (
                                    <>
                                        <div className="flex flex-col md:flex-row items-end gap-6 p-6 -mx-4 -mt-4 md:-mx-8 md:-mt-8 relative overflow-hidden">
                                            <div className={`absolute inset-0 z-0 bg-gradient-to-b ${activeTopic.coverImage ? 'from-zinc-700 to-zinc-900' : `${activeTopic.coverColor || 'from-gray-700'} to-zinc-900/50`} opacity-50`}></div>
                                            {activeTopic.coverImage && (
                                                <div className="absolute inset-0 z-0 opacity-30">
                                                    <img src={activeTopic.coverImage} className="w-full h-full object-cover blur-3xl" alt="" />
                                                </div>
                                            )}

                                            <div className="w-48 h-48 shadow-2xl z-10 flex-shrink-0 mx-auto md:mx-0 rounded-sm overflow-hidden bg-zinc-800">
                                                <CoverArt topic={activeTopic} className="w-full h-full" iconSize={64} />
                                            </div>
                                            
                                            <div className="flex flex-col gap-2 w-full text-center md:text-left z-10">
                                                <span className="uppercase text-xs font-bold tracking-wider">Lección</span>
                                                <h1 className="text-3xl md:text-6xl font-black shadow-black drop-shadow-md">{activeTopic.title}</h1>
                                                <p className="text-white/80">{activeTopic.description}</p>
                                                <div className="flex items-center gap-2 mt-2 justify-center md:justify-start text-sm font-bold">
                                                    <span>{activeTopic.author}</span>
                                                    <span className="w-1 h-1 bg-white rounded-full"></span>
                                                    <span>{activeTopic.chapters.length} capítulos</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="py-6 relative z-10">
                                            <button 
                                                onClick={() => activeTopic.chapters.length > 0 && playTrack(activeTopic.chapters[0], activeTopic)} 
                                                className="w-14 h-14 bg-green-500 rounded-full flex items-center justify-center hover:scale-105 transition shadow-lg"
                                            >
                                                {Play && <Play fill="black" className="text-black ml-1"/>}
                                            </button>
                                        </div>

                                        <div className="flex flex-col relative z-10">
                                            <div className="grid grid-cols-[16px_1fr_auto] gap-4 px-4 py-2 border-b border-white/10 text-zinc-400 text-sm mb-2 sticky top-0 bg-black/90 z-10">
                                                <span>#</span><span>Título</span>{Clock && <Clock size={16}/>}
                                            </div>
                                            {activeTopic.chapters.map((chapter, index) => {
                                                const isCurrent = currentTrack?.id === chapter.id;
                                                return (
                                                    <div key={chapter.id} onClick={() => playTrack(chapter, activeTopic)} className={`grid grid-cols-[16px_1fr_auto] gap-4 px-4 py-3 rounded-md hover:bg-white/10 cursor-pointer group items-center text-sm ${isCurrent ? 'text-green-500' : 'text-zinc-400'}`}>
                                                        <span className="flex justify-center w-4">
                                                            {isCurrent && (isPlaying || isBuffering) ? 
                                                                (isBuffering ? (Loader2 && <Loader2 size={12} className="animate-spin"/>) : <div className="w-3 h-3 bg-green-500 rounded-full animate-pulse"/>) 
                                                                : <span className="group-hover:hidden">{index + 1}</span>
                                                            }
                                                            {Play && <Play size={12} className={`hidden ${isCurrent && (isPlaying || isBuffering) ? '' : 'group-hover:block'} text-white`}/>}
                                                        </span>
                                                        <div className="flex flex-col min-w-0">
                                                            <span className={`text-base font-medium truncate ${isCurrent ? 'text-green-500' : 'text-white'}`}>{chapter.title}</span>
                                                        </div>
                                                        <span>{chapter.duration || "--:--"}</span>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    </>
                                )}
                                <div className="h-20"></div>
                            </div>
                        </main>
                    </div>

                    {/* FOOTER PLAYER */}
                    <footer className="h-24 bg-black border-t border-zinc-800 px-4 flex items-center justify-between z-50">
                        <div className="w-1/3 flex items-center gap-4">
                            {currentTrack && (
                                <>
                                    <div className="hidden md:block w-14 h-14 rounded overflow-hidden bg-zinc-800">
                                        <CoverArt topic={activeTopic} className="w-full h-full" iconSize={24} />
                                    </div>
                                    <div className="flex flex-col overflow-hidden">
                                        <span className="text-sm font-medium text-white truncate">{currentTrack.title}</span>
                                        <span className="text-xs text-zinc-400 truncate">{activeTopic?.title}</span>
                                        {playbackError && (
                                            <div className="flex items-center gap-2 text-xs text-red-500 animate-pulse mt-1 bg-red-500/10 p-1 rounded">
                                                <span className="truncate">{playbackError}</span>
                                            </div>
                                        )}
                                    </div>
                                </>
                            )}
                        </div>

                        <div className="w-1/3 flex flex-col items-center gap-2">
                            <div className="flex items-center gap-6">
                                <button onClick={() => playNextOrPrev('prev')} className="text-zinc-400 hover:text-white">{SkipBack && <SkipBack size={20}/>}</button>
                                <button 
                                    onClick={() => setIsPlaying(!isPlaying)} 
                                    disabled={!currentTrack || isBuffering}
                                    className="w-8 h-8 bg-white rounded-full flex items-center justify-center hover:scale-105 transition disabled:opacity-50"
                                >
                                    {isBuffering ? (Loader2 && <Loader2 size={20} className="text-black animate-spin"/>) : (isPlaying ? (Pause && <Pause size={20} fill="black" className="text-black"/>) : (Play && <Play size={20} fill="black" className="text-black ml-1"/>))}
                                </button>
                                <button onClick={() => playNextOrPrev('next')} className="text-zinc-400 hover:text-white">{SkipForward && <SkipForward size={20}/>}</button>
                            </div>
                            <div className="w-full flex items-center gap-2 text-xs text-zinc-400">
                                <span>{formatTime(audioRef.current?.currentTime || 0)}</span>
                                <div className="h-1 flex-1 bg-zinc-600 rounded-full relative group">
                                    <div className="h-full bg-white group-hover:bg-green-500" style={{ width: `${progress}%` }}></div>
                                    <input type="range" min="0" max="100" value={progress} onChange={(e) => {
                                        const newTime = (e.target.value / 100) * duration;
                                        if(audioRef.current) audioRef.current.currentTime = newTime;
                                        setProgress(e.target.value);
                                    }} className="absolute inset-0 w-full opacity-0 cursor-pointer" disabled={!currentTrack}/>
                                </div>
                                <span>{formatTime(duration)}</span>
                            </div>
                        </div>

                        <div className="w-1/3 flex justify-end items-center gap-2">
                            {Volume2 && <Volume2 size={20} className="text-zinc-400"/>}
                            <div className="w-20 h-1 bg-zinc-600 rounded-full hidden md:block"><div className="w-2/3 h-full bg-zinc-400 hover:bg-green-500 rounded-full"></div></div>
                        </div>
                    </footer>

                    {/* MOTOR DE AUDIO */}
                    {currentTrack && (
                        <audio 
                            key={currentTrack.id}
                            ref={audioRef} 
                            src={currentTrack.url}
                            preload="metadata"
                            onTimeUpdate={handleTimeUpdate} 
                            onEnded={() => playNextOrPrev('next')} 
                            onLoadedData={handleLoadedData}
                            onWaiting={handleWaiting}
                            onError={handleAudioError}
                        />
                    )}
                </div>
            );
        }

        // --- RENDERIZADO ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
